function add(){$("#errorPage").val(""),$("#eNamePage2").val(""),$("#eNamePage1").val(""),$("#namePage").val(""),$(".Validform_checktip").text(""),$("#memberForm3").attr("id","memberForm2"),$("#cName").val(""),$("#eNameLast").val(""),$("#eNameFirst").val(""),$("#idselect").empty(),$(".idInfo").empty(),$("#phone").val(""),$("#gender").val(""),$("#birth").val(""),$(".btn").find("button").eq(0).hide(),$(".btn").find("button").eq(1).hide(),$(".btn").find("button").eq(2).show(),$("#memberForm2").Validform({btnSubmit:"#addCommon",datatype:{sf:yzsfz},tiptype:function(e,a,t){if(a.obj.is("form")){var n=a.obj.find("#msgdemo");t(n,a.type),n.text(e)}else{var n=a.obj.siblings(".Validform_checktip");t(n,a.type),n.text(e)}},ajaxPost:!0,beforeSubmit:function(e){return shangchuan(),!1},beforeCheck:function(){return checkCEName(),!0}}),$.getJSON("pcCommonTraller_add.action",function(e){if("y"==e.status){for(var a=JSON.parse(e.info),t=a.type,n='<option value="">添加证件</option>',r=0;r<t.length;r++)n+='<option value="'+t[r].name+'" name="'+t[r].id+'">'+t[r].name+"</option>";$("#idselect").html(n),$.slide({id:"modify_dialog",content:$(".modify_dialog").get(0),lock:!0})}})}function xiugai(){$("#errorPage").val(""),$("#eNamePage2").val(""),$("#eNamePage1").val(""),$("#namePage").val(""),$(".Validform_checktip").text(""),$("#memberForm2").attr("id","memberForm3");var e=$(this).parent().find("input").val();$("#idselect").empty(),$(".idInfo").empty(),$(".btn").find("button").eq(0).show(),$(".btn").find("button").eq(1).show(),$(".btn").find("button").eq(2).hide(),$("#memberForm3").Validform({btnSubmit:"#editCommon",datatype:{sf:yzsfz},tiptype:function(e,a,t){if(a.obj.is("form")){var n=a.obj.find("#msgdemo");t(n,a.type),n.text(e)}else{var n=a.obj.siblings(".Validform_checktip");t(n,a.type),n.text(e)}},ajaxPost:!0,beforeSubmit:function(e){return edit(),!1},beforeCheck:function(){return checkCEName(),!0}}),$.ajax({url:"pcCommonTraller_editCommon.action",type:"post",dataType:"json",data:{id:e},success:function(e){if("y"==e.status){var a=JSON.parse(e.info);if(JM.isNull(a.traveller.chaName)||$("#cName").val(a.traveller.chaName),!JM.isNull(a.traveller.engName)){var t=a.traveller.engName.indexOf(" "),n=a.traveller.engName.substr(0,t),r=a.traveller.engName.substr(t+1);$("#eNameLast").val(r),$("#eNameFirst").val(n)}$("#travellerId").val(a.traveller.id),$("#phone").val(a.traveller.phone),$("#gender").val(a.traveller.gender),$("#birth").val(a.traveller.birth);for(var i=a.list,l="",o=0;o<i.length;o++)l+="身份证"==i[o].cardType?'<div class="lst clearfix"><input type="hidden"  value="'+i[o].id+'" id="cardId"/><label><span><i class="push_icon"></i>'+i[o].cardType+'</span><input type="text" name="'+i[o].cardType+'" value="'+i[o].cardValue+'" id="cardValues" datatype="sf" errormsg="请输入正确的15位或18位的证件号码" placeholder="请输入证件号码"/><p class="Validform_checktip" style="display:inline;"></p></label><div>':'<div class="lst clearfix"><input type="hidden" value="'+i[o].id+'" id="cardId"/><label><span><i class="push_icon"></i>'+i[o].cardType+'</span><input type="text" name="" value="'+i[o].cardValue+'" id="cardValues" datatype="*" errormsg="请输入正确的证件号码" placeholder="请输入证件号码"/><p class="Validform_checktip" style="display:inline;"></p></label><div>';$(".idInfo").html(l);for(var s=a.type,d='<option value="">添加证件</option>',o=0;o<s.length;o++)d+='<option value="'+s[o].name+'" name="'+s[o].id+'">'+s[o].name+"</option>";$("#idselect").html(d);for(var o=0;o<s.length;o++)for(var c=0;c<i.length;c++){s[o].name,i[c].cardType;s[o].name==i[c].cardType&&$("#idselect").find("option[name="+s[o].id+"]").hide()}$.slide({id:"modify_dialog",content:$(".modify_dialog").get(0),lock:!0})}}})}function sftg(){var e=$("#memberForm3").Validform().check(!1,"#cardValues");return alert(e),!!e}function checkCName(){var e=$("#cName").val(),a=/^[\u4e00-\u9fa5]{2,5}$/;return a.test(e)?($("#namePage").hide(),!0):($("#namePage").html("请输入正确信息"),$("#namePage").show(),!1)}function checkENameL(){var e=$("#eNameLast").val(),a=/^[A-Za-z]+$/;return a.test(e)?($("#eNamePage1").hide(),!0):($("#eNamePage1").html("请输入正确信息"),$("#eNamePage1").show(),!1)}function checkENameF(){var e=$("#eNameFirst").val(),a=/^[A-Za-z]+$/;return a.test(e)?($("#eNamePage2").hide(),!0):($("#eNamePage2").html("请输入正确信息"),$("#eNamePage2").show(),!1)}function leastChooseOneName(){var e=$("#cName").val(),a=$("#eNameLast").val(),t=$("#eNameFirst").val(),n=t+" "+a;return""!=e&&null!=e&&void 0!=e||" "!=n&&null!=n&&void 0!=n?($("#namePage").hide(),$("#eNamePage1").hide(),$("#eNamePage2").hide(),!0):($("#namePage").html("必须填写中文名或者英文名其中一个"),$("#namePage").show(),!1)}function checkCEName(){var e=$("#cName").val(),a=$("#eNameLast").val(),t=$("#eNameFirst").val(),n=t+" "+a,r=""==e||null==e||void 0==e,i=" "==n||null==n||void 0==n;return r&&i?($("#namePage").html("必须填写中文名或者英文名其中一个"),$("#namePage").show(),!1):(r?i?checkCName()&&checkENameF()&&checkENameL()&&$("#namePage").hide():checkENameF()&&checkENameL()&&$("#namePage").hide():checkCName(),!0)}function shengFZ(){for(var e=$(".idInfo .lst label input"),a=$(".idInfo .lst span"),t=e.length,n=0;n<t;n++){var r=$(e[n]),i=$(a[n]).text(),l=r.val();if(18==l.length&&null!=l&&"身份证"==i){var o,s=l.substring(16,17),d=parseInt(s);o=d%2==0?"女":"男";var c=l.substring(6,14),m=c.substring(0,4),u=c.substring(4,6),p=c.substring(6,8),v=m+"-"+u+"-"+p;$("#birth").val(v),$("#gender").val(o)}}}function XGshengFZ(){for(var e=$(".idInfo").find("input[id='cardValues']"),a=$(".idInfo .lst span"),t=e.length,n=0;n<t;n++){var r=$(e[n]),i=$(a[n]).text(),l=r.val();if(18==l.length&&null!=l&&"身份证"==i){var o,s=l.substring(16,17),d=parseInt(s);o=d%2==0?"女":"男";var c=l.substring(6,14),m=c.substring(0,4),u=c.substring(4,6),p=c.substring(6,8),v=m+"-"+u+"-"+p;$("#birth").val(v),$("#gender").val(o)}}}function shangchuan(){for(var e=$("#cName").val(),a=$("#eNameLast").val(),t=$("#eNameFirst").val(),n=t+" "+a,r=$("#phone").val(),i=$("#gender").val(),l=$("#birth").val(),o=$(".idInfo .lst label input"),s=$(".idInfo .lst span"),d=o.length,c=new Array,m=new Array,u=0;u<d;u++){var p=$(o[u]),v=$(s[u]).text(),f=p.val();c[u]=v,m[u]=f}yesOrNo()&&$.ajax({url:"pcCommonTraller_addTraveller.action",type:"post",data:{chaName:e,engName:n,phone:r,typeList:c.join(","),valueList:m.join(","),gender:i,birth:l},dataType:"json",success:function(e){if("y"==e.status){var a=JSON.parse(e.info).id;$.ajax({url:"pcCommonTrallerCard_add.action",type:"post",dataType:"json",data:{valueList:m.join(","),typeList:c.join(","),parentId:a},success:function(e){"y"==e.status&&JM.alert(e.info,2e3,function(){JM.goUrl($("#manageLink").attr("href"))})}})}else alert(e.info)},error:function(){alert("页面出错了")}})}function edit(){for(var e=$("#cName").val(),a=$("#eNameLast").val(),t=$("#eNameFirst").val(),n=t+" "+a,r=$("#phone").val(),i=$("#gender").val(),l=$("#birth").val(),o=$(".idInfo .lst label input"),s=$(".idInfo .lst span"),d=o.length,c=new Array,m=new Array,u=0;u<d;u++){var p=$(o[u]),v=$(s[u]).text(),f=p.val();c[u]=v,m[u]=f}for(var h=$(".idInfo").find("input[id='cardId']"),g=new Array,u=0;u<h.length;u++){var b=$(h[u]).val();g[u]=b}var N=$("#travellerId").val();yesOrNo()&&$.ajax({url:"pcCommonTraller_xiugai.action",type:"post",dataType:"json",data:{chaName:e,engName:n,phone:r,typeList:c.join(","),valueList:m.join(","),gender:i,birth:l,id:N},success:function(e){"y"==e.status&&$.ajax({url:"pcCommonTrallerCard_edit.action",type:"post",dataType:"json",data:{valueList:m.join(","),typeList:c.join(","),parentId:N,idList:g.join(",")},success:function(e){"y"==e.status?JM.alert(e.info,2e3,function(){JM.goUrl($("#manageLink").attr("href"))}):alert(e.info)}})}})}function yesOrNo(){var e=!0,a=0,t=$(".idInfo").children();t.children().length<1&&($("#errorPage").html("点击添加按钮填写证件信息"),$("#errorPage").show(),e=!1);var n=$("#cName").val(),r=$("#eNameLast").val(),i=$("#eNameFirst").val(),l=i+" "+r,o=($("#phone").val(),$("#gender").val(),$("#birth").val(),""==n||null==n||void 0==n),s=" "==l||null==l||void 0==l;return o&&s&&(a=leastChooseOneName()),o&&s||(a=o?s?checkCName()*checkENameL()*checkENameF()*e:checkENameL()*checkENameF()*e:checkCName()*e),0!=a}function yzsfz(e,a,t,n){var r=/^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/,i=/^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$/;if(!r.test(e)&&!i.test(e))return!1;if(18==e.length){for(var l=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2),o=new Array(1,0,10,9,8,7,6,5,4,3,2),s=0,d=0;d<17;d++)s+=e.substring(d,d+1)*l[d];var c=s%11,m=e.substring(17);return 2==c?"X"==m||"x"==m:m==o[c]}if(15==e.length){var $=e.substring(6,8),u=e.substring(8,10),p=e.substring(10,12),v=new Date($,parseFloat(u)-1,parseFloat(p));return v.getYear()==parseFloat($)&&v.getMonth()==parseFloat(u)-1&&v.getDate()==parseFloat(p)}}function del(){var e=$("#travellerId").val(),a=$("#manageLink").attr("href");$.ajax({url:"pcCommonTraller_del.action",type:"post",dataType:"json",data:{id:e},success:function(t){"y"==t.status?$.ajax({url:"pcCommonTrallerCard_del.action",type:"post",dataType:"json",data:{parentId:e},success:function(e){"y"==e.status?JM.alert(e.info,2e3,function(){JM.goUrl(a)}):JM.alert(e.info,2e3)}}):JM.alert(t.info,2e3)}})}$(function(){$(".modify_btn").click(xiugai),$("#delCommon").click(del),$("#eNameFirst").blur(checkCEName),$("#cName").blur(checkCEName),$(".idInfo").on("blur","input[name='身份证']",function(){var e=$("#memberForm2").Validform().check(!1,".card"),a=$(".card").val();JM.isNull(a)&&(e=!1);var t=$("#memberForm3").Validform().check(!1,"#cardValues"),n=$("#cardValues").val();JM.isNull(n)&&(t=!1),e?shengFZ():($("#memberForm2").find("#gender").val(""),$("#memberForm2").find("#birth").val("")),t?XGshengFZ():($("#memberForm3").find("#gender").val(""),$("#memberForm3").find("#birth").val(""))}),$(function(){var e=$('<div class="lst clearfix"><label><span><i class="push_icon"></i> 中文名</span><label><input type="input" placeholder="请输入证件号码"><p class="Validform_checktip" style="display:inline;"></p></div>');$("#idselect").change(function(a){if($(this).val()){var t=$('option[value="'+$(this).val()+'"]',this).html();"身份证"==t&&($(e).find("input").attr("datatype","sf"),$(e).find("input").attr("errormsg","请输入正确的15位或18位的证件号码"),$(e).find("input").attr("class","card")),"护照"==t&&$(e).find("input").attr("datatype","*"),$(e).find("span").html('<i class="push_icon"></i>'+t),$(e).find("input").attr("id",$(this).find("option:selected").attr("name")),$(e).find("input").attr("name",t),$(".idInfo").append($(e).clone()),$('option[value="'+$(this).val()+'"]').hide(),$("#errorPage").hide(),$(this).find("option").eq(0).attr("selected","selected")}}),$(".idInfo").on("click","label i",function(){$(this).parent().parent().parent().empty();var e=$(this).parent().text();$("option[value='"+e+"']").show()}),$('span[for="idselect"]').on("tap",function(){$("#idselect").trigger("onfocus")})})});